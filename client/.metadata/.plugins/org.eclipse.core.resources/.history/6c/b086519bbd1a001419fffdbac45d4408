package com.ui
{
    import assets.*;
    import com.sina.finance.data.*;
    import com.sina.finance.ui.*;
    import flash.display.*;
    import flash.events.*;
    import flash.geom.*;
    import flash.net.*;
    import flash.system.*;
    import flash.text.*;
    import flash.utils.*;

    public class ShareMainBtn extends Sprite implements IUis
    {
        private const _LOGO_OFFSET:uint = 34;
        private var _panel:Sprite;
        private var _containerMask:Sprite;
        private var _htmlT:TextField;
        private var _entryPartY:uint = 0;
        private const _LINE_2_Y:uint = 160;
        private var _pressCount:int;
        private const _LEFT_X:uint = 30;
        private var _dropMenu:DropdownMenu;
        private const _BORDER_COLOR:uint = 13361904;
        private const _LINE_1_Y:uint = 100;
        private var _wb:ShareTo;
        private var _iconStatus:uint = 0;
        private const _PANEL_H:uint = 345;
        private var _pressTimeout:uint;
        private const _PANEL_W:uint = 430;
        private var _centerFormat:TextFormat;
        private var _viewLbs:LabelBtnPanel;
        private var _btn:BtnMcShare;
        private var _urlerContainer:Sprite;
        private var _cfg:Config;
        private var _pageT:TextField;
        private var _shareBtnsContainer:Sprite;
        private const _LOGO_WH:uint = 24;
        private var _isPressing:Boolean = false;
        private var _urlTxtFormat:TextFormat;
        private var _overLogoTip:TextField;
        private var _shareIconsLoader:Loader;
        private var _HOLDING_TIME:uint = 500;
        private var _urlWord:String = "";
        private var _copyBtnH:uint = 20;
        private const _LINE_3_Y:uint = 220;
        private const _PANEL_TOP_H:uint = 70;
        private var _urlId:int = 0;
        private var _swfT:TextField;
        private var _s:String;
        private var _copyBtnW:uint = 53;
        private var _onlySwfUrl:String;
        private var _n:String;

        public function ShareMainBtn(param1:String, param2:String)
        {
            this._cfg = Config.getInstance();
            this._wb = ShareTo.getInstance();
            this._btn = new BtnMcShare();
            this._urlTxtFormat = new TextFormat("arial", 12, 10066329);
            this._centerFormat = new TextFormat("arial", 12, this._cfg.LB_COLOR, null, null, null, null, null, "center");
            this._n = param1;
            this._s = param2;
            if (stage)
            {
                this.init();
            }
            else
            {
                addEventListener(Event.ADDED_TO_STAGE, this.init);
            }
            return;
        }// end function

        private function loadShareIcons() : void
        {
            if (this._iconStatus == 1 || this._iconStatus == 2)
            {
                return;
            }
            this._iconStatus = 2;
            if (!this._shareIconsLoader)
            {
                this._shareIconsLoader = new Loader();
            }
            this._shareIconsLoader.contentLoaderInfo.addEventListener(Event.COMPLETE, this.shareIconsLoaded);
            this._shareIconsLoader.contentLoaderInfo.addEventListener(IOErrorEvent.IO_ERROR, this.shareIconsIoErr);
            this._shareIconsLoader.load(new URLRequest("http://www.sinaimg.cn/cj/hsuan/img/shareicons.png"), new LoaderContext(true));
            return;
        }// end function

        private function initKaixinBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.KAIXIN, "开心网");
            _loc_1.x = this._LOGO_OFFSET * 7 - 3;
            return;
        }// end function

        private function initBaiduBlogBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.BAIDU_BLOG, "百度空间");
            _loc_1.x = this._LOGO_OFFSET * 5 - 1;
            return;
        }// end function

        private function initUrlCopyer() : void
        {
            this._urlerContainer = new Sprite();
            this._urlerContainer.x = this._LEFT_X;
            this._urlerContainer.y = this._LINE_3_Y;
            this._panel.addChild(this._urlerContainer);
            this.newInfo(this._swfT, "Flash地址");
            this.newInfo(this._htmlT, "HTML代码");
            this.newInfo(this._pageT, "页面地址");
            return;
        }// end function

        private function initPanel() : void
        {
            var _loc_1:TextField = null;
            if (!this._panel)
            {
                this._panel = new PopoutPanel(this.closeMe);
                this._containerMask.addChildAt(this._panel, 0);
                _loc_1 = this.newTxtField("提示：您可以选择转发截图或者复制代码、地址的形式进行分享。", true, this._PANEL_W);
                _loc_1.y = 40;
                this._panel.addChild(_loc_1);
            }
            this._panel.x = (this._cfg.viewW - this._PANEL_W) * 0.5;
            this._panel.y = (this._cfg.viewH - this._PANEL_H) * 0.5;
            return;
        }// end function

        private function init(event:Event = null) : void
        {
            removeEventListener(Event.ADDED_TO_STAGE, this.init);
            stage.addEventListener(MouseEvent.MOUSE_OUT, this.onOut);
            this._onlySwfUrl = "http://finance.sina.com.cn/flash/cn.swf";
            var _loc_2:* = this._onlySwfUrl.indexOf("?");
            if (_loc_2 > 0)
            {
                this._onlySwfUrl = this._onlySwfUrl.substr(0, _loc_2);
            }
            this._htmlT = this.newTxtField();
            this._htmlT.name = "copyhtml";
            this._swfT = this.newTxtField();
            this._swfT.name = "copyswf";
            this._pageT = this.newTxtField();
            this._pageT.name = "copyurl";
            this.resize();
            this.initMainBtn();
            this.setContainer();
            this.placeCtrls();
            return;
        }// end function

        private function init163WeiboBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.NTES_WEIBO, "网易微博");
            _loc_1.x = this._LOGO_OFFSET * 3;
            return;
        }// end function

        private function onClkLogo(event:MouseEvent) : void
        {
            DisplayMgr(this.parent).goFullScreen(null, true);
            this._containerMask.visible = true;
            if (this.parent && this.parent.contains(this))
            {
                this.parent.addChild(this);
            }
            this.updateUrlCopy("");
            if (this._viewLbs)
            {
                this._viewLbs.selecteDefault(0);
            }
            return;
        }// end function

        private function directSend(param1:String = null) : void
        {
            this._btn.gotoAndStop(1);
            DisplayMgr(this.parent).goFullScreen(null, true);
            this._wb.send(stage, this._n, this._s, param1, this._urlWord);
            return;
        }// end function

        private function onDown(event:MouseEvent) : void
        {
            clearTimeout(this._pressTimeout);
            this._isPressing = true;
            this._pressCount = getTimer();
            return;
        }// end function

        private function initSohuWeiboBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.SOHU_WEIBO, "搜狐微博");
            _loc_1.x = this._LOGO_OFFSET * 4 - 2;
            return;
        }// end function

        public function placeIcon(param1:Boolean = true) : void
        {
            this._btn.y = this._cfg.posY + this._cfg.hMain + this._cfg.hTimeLb + this._cfg.iconBtnOffsetY + this._cfg.GAP_ICON_BTN * (param1 ? (1) : (4));
            return;
        }// end function

        private function newTxtField(param1:String = "", param2:Boolean = false, param3:uint = 0, param4:Boolean = false) : TextField
        {
            var _loc_5:* = new TextField();
            if (param2)
            {
                if (param3 > 0)
                {
                    _loc_5.width = param3;
                    _loc_5.height = 20;
                }
                else
                {
                    _loc_5.autoSize = "left";
                }
                _loc_5.mouseEnabled = false;
                _loc_5.defaultTextFormat = this._centerFormat;
                if (param4)
                {
                    _loc_5.background = true;
                    _loc_5.backgroundColor = 16777215;
                    _loc_5.border = true;
                    _loc_5.borderColor = this._BORDER_COLOR;
                }
            }
            else
            {
                _loc_5.width = this._PANEL_W - 200;
                _loc_5.height = 20;
                _loc_5.background = true;
                _loc_5.backgroundColor = 16777215;
                _loc_5.border = true;
                _loc_5.borderColor = this._BORDER_COLOR;
                _loc_5.defaultTextFormat = this._urlTxtFormat;
                _loc_5.addEventListener(MouseEvent.CLICK, this.clkEntry);
            }
            _loc_5.text = param1;
            return _loc_5;
        }// end function

        private function initSinaWeiboBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.SINA_WEIBO, "新浪微博");
            return;
        }// end function

        private function setContainer() : void
        {
            this._containerMask = new Sprite();
            this._containerMask.visible = false;
            this._containerMask.graphics.beginFill(16777215, 0.5);
            this._containerMask.graphics.drawRect(0, 0, this._cfg.viewW, this._cfg.viewH);
            this._containerMask.graphics.endFill();
            addChild(this._containerMask);
            this.initPanel();
            return;
        }// end function

        private function onOver(event:MouseEvent) : void
        {
            this._btn.gotoAndStop(2);
            return;
        }// end function

        private function setTypeIdAndRefresh(param1:int) : void
        {
            this._urlWord = UrlHashDecoder.getWordFromId(param1, false);
            this._urlId = param1;
            this.updateUrlCopy();
            return;
        }// end function

        private function shareIconsLoaded(event:Event) : void
        {
            this._iconStatus = 1;
            event.target.removeEventListener(Event.COMPLETE, this.shareIconsLoaded);
            event.target.removeEventListener(IOErrorEvent.IO_ERROR, this.shareIconsIoErr);
            Bitmap(this._shareIconsLoader.content).smoothing = true;
            return;
        }// end function

        private function clkEntry(event:MouseEvent) : void
        {
            var _loc_2:* = TextField(event.currentTarget);
            _loc_2.setSelection(0, _loc_2.length);
            return;
        }// end function

        private function updateUrlCopy(param1:String = null) : void
        {
            var _loc_2:* = param1 != null ? (param1) : (this._urlWord);
            var _loc_3:* = this._onlySwfUrl + "?symbol=" + this._s + (_loc_2 != "" ? ("&view=" + _loc_2) : (""));
            var _loc_4:* = "<embed src=\"" + _loc_3 + "\"" + " quality=\"high\"" + " type=\"application/x-shockwave-flash\"" + " allowscriptaccess=\"always\"" + " allowfullscreen=\"true\"" + " wmode=\"opaque\"" + " width=\"" + 560 + "\"" + " height=\"" + 490 + "\">" + "</embed>";
            var _loc_5:* = /[gz]/.test(this._cfg.stockType) ? (this._cfg.BOND_URL.replace("$symbol", this._s)) : (this._cfg.FINANCE_URL + this._s + "/nc.shtml");
            _loc_5 = (/[gz]/.test(this._cfg.stockType) ? (this._cfg.BOND_URL.replace("$symbol", this._s)) : (this._cfg.FINANCE_URL + this._s + "/nc.shtml")) + (_loc_2 != "" ? ("?view=" + _loc_2) : (""));
            this._htmlT.text = _loc_4;
            this._swfT.text = _loc_3;
            this._pageT.text = _loc_5;
            return;
        }// end function

        private function initShareLb() : void
        {
            var _loc_1:* = this.newTxtField("转发截图>", true);
            _loc_1.x = this._LEFT_X;
            _loc_1.y = this._LINE_1_Y;
            this._panel.addChild(_loc_1);
            return;
        }// end function

        private function newInfo(param1:TextField, param2:String, param3:String = null) : void
        {
            var _loc_4:* = this.newTxtField(param2, true);
            this.newTxtField(param2, true).y = this._entryPartY;
            this._urlerContainer.addChild(_loc_4);
            param1.x = 70;
            param1.y = this._entryPartY;
            this._urlerContainer.addChild(param1);
            var _loc_5:* = this.newCopyBtn(param1, param3);
            this.newCopyBtn(param1, param3).x = param1.x + param1.width + 10;
            _loc_5.y = this._entryPartY + 1;
            this._urlerContainer.addChild(_loc_5);
            this._entryPartY = this._entryPartY + 30;
            return;
        }// end function

        private function initQZoneBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.QQ_ZONE, "QQ空间");
            _loc_1.x = this._LOGO_OFFSET;
            return;
        }// end function

        private function placeCtrls() : void
        {
            this.initShareLb();
            this.initShareBtns();
            this.initCopyLb();
            this.initUrlCopyer();
            this.initViewSelector();
            return;
        }// end function

        private function shareIconsIoErr(event:IOErrorEvent) : void
        {
            event.target.removeEventListener(Event.COMPLETE, this.shareIconsLoaded);
            event.target.removeEventListener(IOErrorEvent.IO_ERROR, this.shareIconsIoErr);
            this._iconStatus = 0;
            return;
        }// end function

        public function closeMe(event:MouseEvent = null) : void
        {
            this._containerMask.visible = false;
            return;
        }// end function

        private function initMainBtn() : void
        {
            this._btn.gotoAndStop(1);
            this._btn.buttonMode = true;
            this._btn.mouseChildren = false;
            this._btn.addEventListener(MouseEvent.MOUSE_OVER, this.onOver);
            this._btn.addEventListener(MouseEvent.MOUSE_OUT, this.onOut);
            this._btn.addEventListener(MouseEvent.MOUSE_DOWN, this.onDown);
            this._btn.addEventListener(MouseEvent.MOUSE_UP, this.onUp);
            addChild(this._btn);
            return;
        }// end function

        private function newHotArea(param1:Function, param2:String, param3:String = null) : Sprite
        {
            var func:* = param1;
            var shareTarget:* = param2;
            var tip:* = param3;
            var hotArea:* = new Sprite();
            hotArea.buttonMode = true;
            hotArea.graphics.beginFill(0, 0);
            hotArea.graphics.drawRect(0, 0, this._LOGO_WH, this._LOGO_WH);
            hotArea.graphics.endFill();
            hotArea.addEventListener(MouseEvent.CLICK, function (event:MouseEvent) : void
            {
                func(shareTarget);
                return;
            }// end function
            );
            if (tip)
            {
                hotArea.addEventListener(MouseEvent.MOUSE_OVER, function (event:MouseEvent) : void
            {
                _overLogoTip.text = "分享到" + tip;
                _overLogoTip.x = mouseX - _panel.x - _shareBtnsContainer.x - _overLogoTip.width * 0.5;
                _overLogoTip.visible = true;
                return;
            }// end function
            );
                hotArea.addEventListener(MouseEvent.MOUSE_OUT, function (event:MouseEvent) : void
            {
                _overLogoTip.visible = false;
                return;
            }// end function
            );
            }
            this._shareBtnsContainer.addChild(hotArea);
            return hotArea;
        }// end function

        public function resize() : void
        {
            this._btn.x = this._cfg.posX + this._cfg.KW + this._cfg.GAP_MAIN_BTN;
            this.placeIcon();
            return;
        }// end function

        private function initQQWeiboBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.QQ_WEIBO, "腾讯微博");
            _loc_1.x = this._LOGO_OFFSET * 2 - 1;
            return;
        }// end function

        private function initViewSelector() : void
        {
            var _loc_1:* = this.newTxtField("视图选择>", true);
            _loc_1.x = 235;
            _loc_1.y = this._LINE_2_Y;
            this._panel.addChild(_loc_1);
            var _loc_2:Array = [{label:"1日分时", id:UrlHashDecoder.TIME_SHARE_ID}, {label:"5日分时", id:UrlHashDecoder.FAKE_T5DAY_ID}, {label:"年收盘线", id:UrlHashDecoder.CLOSE_LINE_ID}, {label:"日K线", id:UrlHashDecoder.DAY_K_ID}, {label:"周K线", id:UrlHashDecoder.WEEK_K_ID}, {label:"月K线", id:UrlHashDecoder.MONTH_K_ID}, {label:"5分K线", id:UrlHashDecoder.MIN_K_5_ID}, {label:"15分K线", id:UrlHashDecoder.MIN_K_15_ID}, {label:"30分K线", id:UrlHashDecoder.MIN_K_30_ID}, {label:"60分K线", id:UrlHashDecoder.MIN_K_60_ID}];
            this._viewLbs = new LabelBtnPanel(_loc_2, this.setTypeIdAndRefresh);
            this._viewLbs.x = _loc_1.x + _loc_1.width + 10;
            this._viewLbs.y = this._LINE_2_Y;
            this._panel.addChild(this._viewLbs);
            return;
        }// end function

        private function onClkShare(param1:String = null) : void
        {
            this.closeMe();
            this.directSend(param1);
            return;
        }// end function

        private function initShareBtns() : void
        {
            this._shareBtnsContainer = new Sprite();
            this._shareBtnsContainer.x = this._LEFT_X + 100;
            this._shareBtnsContainer.y = this._LINE_1_Y - 1;
            this._panel.addChild(this._shareBtnsContainer);
            this._shareIconsLoader = new Loader();
            this._shareBtnsContainer.addChild(this._shareIconsLoader);
            this._overLogoTip = this.newTxtField("", true, 100, true);
            this._overLogoTip.visible = false;
            this._overLogoTip.y = -28;
            this._shareBtnsContainer.addChild(this._overLogoTip);
            this.initSinaWeiboBtn();
            this.initQZoneBtn();
            this.initQQWeiboBtn();
            this.init163WeiboBtn();
            this.initSohuWeiboBtn();
            this.initBaiduBlogBtn();
            this.initRenrenBtn();
            this.initKaixinBtn();
            return;
        }// end function

        private function newCopyBtn(param1:TextField, param2:String = null) : Sprite
        {
            var tf:TextField;
            var entry:* = param1;
            var txt:* = param2;
            txt = txt ? (txt) : ("复制");
            var btn:* = new Sprite();
            btn.buttonMode = true;
            var m:* = new Matrix();
            m.createGradientBox(this._copyBtnW, this._copyBtnH, Math.PI * 0.5);
            btn.graphics.lineStyle(0, this._BORDER_COLOR);
            btn.graphics.beginGradientFill("linear", [15528703, 13492983], [1, 1], [0, 255], m);
            btn.graphics.drawRoundRect(0, 0, this._copyBtnW, this._copyBtnH, 3);
            btn.graphics.endFill();
            tf = this.newTxtField(txt, true, this._copyBtnW);
            btn.addChild(tf);
            btn.addEventListener(MouseEvent.CLICK, function (event:MouseEvent) : void
            {
                var e:* = event;
                System.setClipboard(entry.text);
                tf.text = "完成";
                setTimeout(function () : void
                {
                    tf.text = txt;
                    return;
                }// end function
                , 2000);
                _cfg.sendStatistic("common.html?type=" + entry.name);
                return;
            }// end function
            );
            return btn;
        }// end function

        private function onUp(event:MouseEvent) : void
        {
            this._urlWord = "";
            if (this._isPressing && getTimer() - this._pressCount > this._HOLDING_TIME)
            {
                this.directSend();
            }
            else
            {
                this.loadShareIcons();
                this.onClkLogo(null);
            }
            this._isPressing = false;
            this._cfg.sendStatistic("common.html?type=share");
            return;
        }// end function

        private function onOut(event:MouseEvent) : void
        {
            this._btn.gotoAndStop(1);
            return;
        }// end function

        private function initRenrenBtn() : void
        {
            var _loc_1:* = this.newHotArea(this.onClkShare, ShareTo.RENREN, "人人网");
            _loc_1.x = this._LOGO_OFFSET * 6 - 3;
            return;
        }// end function

        public function setTypeId(param1:Boolean, param2:uint, param3:Boolean = false) : void
        {
            if (param1 && param2 == 5)
            {
                param2 = 0;
            }
            if (param3)
            {
                param2 = 2;
            }
            this._urlWord = UrlHashDecoder.getWordFromId(param2, param1);
            this._urlId = param2;
            return;
        }// end function

        private function initCopyLb() : void
        {
            var _loc_1:* = this.newTxtField("复制地址、代码>", true);
            _loc_1.x = this._LEFT_X;
            _loc_1.y = this._LINE_2_Y;
            this._panel.addChild(_loc_1);
            return;
        }// end function

    }
}
