package com.ui.dayKNews
{
    import __AS3__.vec.*;
    import com.sina.finance.data.*;
    import com.ui.*;
    import flash.display.*;
    import flash.events.*;
    import flash.text.*;
    import flash.utils.*;
    import hsuan.*;

    public class DayKNews extends Sprite
    {
        private var _panel:PopoutPanel;
        private var _container:Sprite;
        private const _URL:String = "http://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getStockNews?symbol=$symbol&market=$market&date=$date&num=$num";
        private const _TF:TextFormat;
        private var _newsItemStage:Sprite;
        private var _allArr:Array;
        private var _cfg:Config;
        private var _nextPath:Vector.<Number>;
        private var _symbol:String;
        private var _newsItemArr:Array;
        private var _dataTool:DataTool;
        private var _symbolCode:String;
        private var _noNewsTip:TextField;
        private var _curDate:Date;
        private var _market:String;
        private var _cmds:Vector.<int>;
        private var _prevPath:Vector.<Number>;
        private var _topDateTxt:TextField;
        private const _PANEL_H:uint = 345;
        private var _n:String;
        private const _PANEL_W:uint = 430;

        public function DayKNews(param1:String, param2:String, param3:Array)
        {
            this._cfg = Config.getInstance();
            this._dataTool = DataTool.getInstance();
            this._newsItemArr = [];
            this._TF = new TextFormat("arial", 12, this._cfg.LB_COLOR, null, null, null, null, null, "center");
            this._symbol = param1;
            this._market = param1.substr(0, 2);
            this._symbolCode = param1.substring(2);
            this._n = param2;
            this._allArr = param3;
            if (stage)
            {
                this._init();
            }
            else
            {
                addEventListener(Event.ADDED_TO_STAGE, this._init);
            }
            return;
        }// end function

        private function _onClkNavBtn(event:MouseEvent) : void
        {
            this.loadNews(this._getNextDateStr(event.currentTarget.name));
            return;
        }// end function

        private function _setContainer() : void
        {
            this._container = new Sprite();
            this._container.graphics.beginFill(16777215, 0.5);
            this._container.graphics.drawRect(0, 0, this._cfg.viewW, this._cfg.viewH);
            this._container.graphics.endFill();
            addChild(this._container);
            this._initPanel();
            return;
        }// end function

        private function _getNextDateStr(param1:String) : Date
        {
            var _loc_2:int = 0;
            var _loc_3:* = this._allArr.length;
            while (_loc_2 < _loc_3)
            {
                
                if (this._dataTool.isSameDay_date(this._allArr[_loc_2].d, this._curDate))
                {
                    break;
                }
                _loc_2++;
            }
            if (param1 == "p")
            {
                _loc_2 = _loc_2 - 1;
            }
            else
            {
                _loc_2++;
            }
            if (_loc_2 < 0)
            {
                _loc_2 = _loc_3 - 1;
            }
            else if (_loc_2 > (_loc_3 - 1))
            {
                _loc_2 = 0;
            }
            return this._allArr[_loc_2].d;
        }// end function

        private function _showTips(param1:uint = 0, param2:Boolean = false) : void
        {
            if (!this._noNewsTip)
            {
                this._noNewsTip = new TextField();
                this._noNewsTip.defaultTextFormat = this._TF;
                this._noNewsTip.width = this._PANEL_W;
                this._noNewsTip.selectable = false;
                this._noNewsTip.y = this._PANEL_H * 0.5;
                this._panel.addChild(this._noNewsTip);
            }
            switch(param1)
            {
                default:
                {
                    this._noNewsTip.text = "";
                    break;
                }
                case 1:
                {
                    this._noNewsTip.text = "无相关新闻";
                    break;
                }
                case 2:
                {
                    this._noNewsTip.text = "相关新闻加载中...";
                    break;
                }
                case :
                {
                    this._noNewsTip.text = "相关新闻加载失败，请重试";
                    break;
                    break;
                }
            }
            this._noNewsTip.visible = param2;
            return;
        }// end function

        private function _drawNavBtn(param1:Boolean = true) : Sprite
        {
            var _loc_2:Number = 11;
            var _loc_3:Number = 11;
            var _loc_4:* = new Sprite();
            new Sprite().buttonMode = true;
            _loc_4.graphics.lineStyle(0, 13953012);
            _loc_4.graphics.beginFill(16317438);
            _loc_4.graphics.drawRect(0, 0, 43, 43);
            _loc_4.graphics.endFill();
            _loc_4.addEventListener(MouseEvent.CLICK, this._onClkNavBtn);
            var _loc_5:* = new Shape();
            _loc_4.addChild(_loc_5);
            _loc_5.graphics.beginFill(13360886);
            if (param1)
            {
                _loc_5.graphics.drawPath(this._cmds, this._prevPath);
                _loc_4.name = "p";
            }
            else
            {
                _loc_5.graphics.drawPath(this._cmds, this._nextPath);
                _loc_4.name = "n";
            }
            _loc_5.graphics.endFill();
            _loc_5.x = 11;
            _loc_5.y = 10;
            return _loc_4;
        }// end function

        private function _initNavBtnPath() : void
        {
            var _loc_1:Number = 22;
            var _loc_2:* = _loc_1 * 0.5;
            var _loc_3:Number = 24;
            var _loc_4:* = _loc_3 * 0.5;
            this._cmds = new Vector.<int>(7, true);
            this._cmds[0] = 1;
            this._cmds[1] = 2;
            this._cmds[2] = 2;
            this._cmds[3] = 2;
            this._cmds[4] = 2;
            this._cmds[5] = 2;
            this._cmds[6] = 2;
            this._nextPath = new Vector.<Number>(14, true);
            this._nextPath[0] = 0;
            this._nextPath[1] = 0;
            this._nextPath[2] = _loc_2;
            this._nextPath[3] = 0;
            this._nextPath[4] = _loc_1;
            this._nextPath[5] = _loc_4;
            this._nextPath[6] = _loc_2;
            this._nextPath[7] = _loc_3;
            this._nextPath[8] = 0;
            this._nextPath[9] = _loc_3;
            this._nextPath[10] = _loc_2;
            this._nextPath[11] = _loc_4;
            this._nextPath[12] = 0;
            this._nextPath[13] = 0;
            this._prevPath = new Vector.<Number>(14, true);
            this._prevPath[0] = _loc_1;
            this._prevPath[1] = 0;
            this._prevPath[2] = _loc_2;
            this._prevPath[3] = 0;
            this._prevPath[4] = 0;
            this._prevPath[5] = _loc_4;
            this._prevPath[6] = _loc_2;
            this._prevPath[7] = _loc_3;
            this._prevPath[8] = _loc_1;
            this._prevPath[9] = _loc_3;
            this._prevPath[10] = _loc_2;
            this._prevPath[11] = _loc_4;
            this._prevPath[12] = _loc_1;
            this._prevPath[13] = 0;
            return;
        }// end function

        private function _initPanel() : void
        {
            var _loc_1:TextField = null;
            var _loc_2:TextField = null;
            var _loc_3:Sprite = null;
            var _loc_4:Sprite = null;
            if (!this._panel)
            {
                this._panel = new PopoutPanel(this._closeMe);
                this._container.addChildAt(this._panel, 0);
                _loc_1 = new TextField();
                _loc_1.defaultTextFormat = new TextFormat("arial", 14, 7804, true);
                _loc_1.autoSize = "left";
                _loc_1.selectable = false;
                _loc_1.text = this._n;
                _loc_1.x = this._PANEL_W * 0.5 - _loc_1.width - 3;
                this._panel.addChild(_loc_1);
                _loc_2 = new TextField();
                _loc_2.defaultTextFormat = new TextFormat("arial", 14, 3112376);
                _loc_2.autoSize = "left";
                _loc_2.selectable = false;
                _loc_2.text = "相关新闻";
                _loc_2.x = this._PANEL_W * 0.5 + 3;
                this._panel.addChild(_loc_2);
                var _loc_5:int = 15;
                _loc_2.y = 15;
                _loc_1.y = _loc_5;
                this._topDateTxt = new TextField();
                this._topDateTxt.defaultTextFormat = new TextFormat("arial", 14, 3112376, null, null, null, null, null, "center");
                this._topDateTxt.width = this._PANEL_W;
                this._topDateTxt.height = 20;
                this._topDateTxt.selectable = false;
                this._topDateTxt.y = 40;
                this._panel.addChild(this._topDateTxt);
                this._initNavBtnPath();
                _loc_3 = this._drawNavBtn(true);
                _loc_4 = this._drawNavBtn(false);
                var _loc_5:int = 15;
                _loc_3.y = 15;
                _loc_4.y = _loc_5;
                _loc_3.x = 45;
                _loc_4.x = 339;
                this._panel.addChild(_loc_3);
                this._panel.addChild(_loc_4);
                this._newsItemStage = new Sprite();
                this._newsItemStage.y = 82;
                this._panel.addChild(this._newsItemStage);
            }
            this._panel.x = (this._cfg.viewW - this._PANEL_W) * 0.5;
            this._panel.y = (this._cfg.viewH - this._PANEL_H) * 0.5;
            return;
        }// end function

        private function _newsLoaded(event:Event) : void
        {
            var datas:Array;
            var curDateStr:String;
            var typeArr:Array;
            var o:Object;
            var k:uint;
            var kl:uint;
            var url:String;
            var title:String;
            var isIgnore:Boolean;
            var newsItem:NewsItem;
            var index:uint;
            var ni:NewsItem;
            var obj:Object;
            var i:uint;
            var e:* = event;
            e.target.removeEventListener(Event.COMPLETE, this._newsLoaded);
            var ba:* = new ByteArray();
            ba.writeBytes(e.target.data);
            ba.position = 0;
            var str:* = ba.readMultiByte(ba.length, "gb2312");
            var jsonStr:* = this._dataTool.fixJsonStr(str);
            try
            {
                datas = Json.decode(jsonStr);
            }
            catch (err:Error)
            {
                _showTips(2, true);
                _cfg.sendStatistic("flasherr.html?type=dknewserr");
                return;
            }
            var j:uint;
            var jl:* = this._allArr.length;
            while (j < jl)
            {
                
                if (this._dataTool.isSameDay_date(this._allArr[j].d, this._curDate))
                {
                    curDateStr = this._dataTool.dateObj2dateStr(this._curDate);
                    typeArr = this._allArr[j].t.split(",");
                    k;
                    kl = typeArr.length;
                    while (k < kl)
                    {
                        
                        url;
                        title;
                        isIgnore;
                        switch(typeArr[k])
                        {
                            case "lhb":
                            {
                                title;
                                url = this._cfg.LHB_URL;
                                break;
                            }
                            case "dzjy":
                            {
                                title;
                                url = this._cfg.DZJY_URL;
                                break;
                            }
                            case "nbjy":
                            {
                                title;
                                url = this._cfg.NBJY_URL;
                                break;
                            }
                            default:
                            {
                                isIgnore;
                                break;
                                break;
                            }
                        }
                        if (isIgnore)
                        {
                        }
                        else
                        {
                            title = this._n + title;
                            url = url.replace("$symbol", this._symbol).replace("$bdate", curDateStr).replace("$edate", curDateStr);
                            o;
                            datas.splice(0, 0, o);
                        }
                        k = (k + 1);
                    }
                }
                j = (j + 1);
            }
            var l:* = Math.min(datas.length, 8);
            while (this._newsItemStage.numChildren < l)
            {
                
                newsItem = new NewsItem();
                this._newsItemStage.addChild(newsItem);
                this._newsItemArr[this._newsItemArr.length] = newsItem;
            }
            while (this._newsItemStage.numChildren > l)
            {
                
                index = (this._newsItemStage.numChildren - 1);
                this._newsItemStage.removeChildAt(index);
                var _loc_3:* = this._newsItemArr;
                var _loc_4:* = this._newsItemArr.length - 1;
                _loc_3.length = _loc_4;
            }
            this._newsItemStage.visible = true;
            if (l <= 0)
            {
                this._showTips(0, true);
            }
            else
            {
                this._showTips(9, false);
                i;
                while (i < l)
                {
                    
                    obj = datas[i];
                    ni = this._newsItemArr[i];
                    ni.setDateTitleUrl(obj.create_date, obj.title, obj.url);
                    ni.y = i * 33;
                    i = (i + 1);
                }
            }
            return;
        }// end function

        public function loadNews(param1:Date) : void
        {
            this._showTips(1, true);
            this._container.visible = true;
            this._newsItemStage.visible = false;
            this._curDate = param1;
            var _loc_2:* = this._dataTool.dateObj2dateStr(param1);
            this._dataTool.loadDataFromUrl(this._URL.replace("$symbol", this._symbolCode).replace("$market", this._market).replace("$date", _loc_2).replace("$num", 8), this._newsLoaded, null, null, null, true);
            this._topDateTxt.text = _loc_2.replace("-", " 年 ").replace("-", " 月 ") + " 日";
            this._cfg.sendStatistic("common.html?type=dknews");
            return;
        }// end function

        private function _init(event:Event = null) : void
        {
            removeEventListener(Event.ADDED_TO_STAGE, this._init);
            this._setContainer();
            return;
        }// end function

        private function _closeMe(event:MouseEvent = null) : void
        {
            this._container.visible = false;
            return;
        }// end function

    }
}
