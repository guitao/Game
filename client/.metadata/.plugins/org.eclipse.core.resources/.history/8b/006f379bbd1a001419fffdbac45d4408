package com.sina.finance.data
{
    import flash.events.*;
    import hsuan.*;

    public class TDataBase extends Object
    {
        public var dates:Array;
        private var _retry5ytCount:uint = 0;
        public var hq:HQ;
        protected const TDATA_URL_END:String = "/hisdata/klc_cm.js?day=";
        public var latest5:Array;
        public var everyT:Object;
        private var _retry1tCount:uint = 0;
        protected var _cfg:Config;
        protected var _lastfive:Number;
        public var initCallBackFun:Function;
        public var inited:Boolean = false;
        protected const _RETRY_COUNT:uint = 3;
        protected var _isFake:Boolean = false;
        protected var _dataTool:DataTool;
        protected const TRADE_URL_HEAD:String;
        public var tDataState:Object;
        public var dates_str:Array;
        public var tdataObj:TDataObjBase;
        public var datas_1:Array;
        public var datas_3:Array;
        public var datas_5:Array;

        public function TDataBase()
        {
            this._cfg = Config.getInstance();
            this._dataTool = DataTool.getInstance();
            this.TRADE_URL_HEAD = this._cfg.JSON_URL_PREFIX + "CN_MarketData.GetTradeDays?symbol=sh000300&start=";
            this.everyT = {};
            return;
        }// end function

        private function dealTimeSharingData(param1:Array) : void
        {
            var _loc_3:Number = NaN;
            var _loc_5:uint = 0;
            var _loc_2:* = param1.length;
            if (_loc_2 > 5)
            {
                param1.splice(0, _loc_2 - 5);
            }
            this.latest5 = [this.datas_1];
            _loc_2 = this.dates.length;
            var _loc_4:* = _loc_2 - 2;
            while (_loc_4 > _loc_2 - 6)
            {
                
                _loc_5 = 0;
                while (_loc_5 < param1.length)
                {
                    
                    if (this.latest5.length > 0)
                    {
                        _loc_3 = this.latest5[0][0].prevclose;
                    }
                    else
                    {
                        _loc_3 = this.hq.prevclose;
                    }
                    if (this._dataTool.isSameDay_date(param1[_loc_5][0].date, this.dates[_loc_4]))
                    {
                        this.latest5.unshift(this._dataTool.setTimeLableForOneDay(param1[_loc_5]));
                        break;
                    }
                    if (_loc_5 == (param1.length - 1))
                    {
                        this.latest5.unshift(this._dataTool.getSpaceTDataByDay(1, _loc_3));
                        this.latest5[0][0].date = this._isFake && param1.length == 1 ? (this.hq.date) : (this._dataTool.cloneDate(this.dates[_loc_4]));
                        this.latest5[0][0].prevclose = _loc_3;
                    }
                    _loc_5 = _loc_5 + 1;
                }
                _loc_4 = _loc_4 - 1;
            }
            this.datas_5 = this.latest5;
            return;
        }// end function

        protected function createBlackTData(param1:Boolean = true) : void
        {
            var _loc_2:String = null;
            if (this._isFake)
            {
                _loc_2 = "blanky";
            }
            else
            {
                if (param1)
                {
                    this._cfg.stockType = "n";
                }
                _loc_2 = "newy";
            }
            this.latest5 = [];
            var _loc_3:uint = 0;
            while (_loc_3 < 4)
            {
                
                this.latest5[this.latest5.length] = this._dataTool.getSpaceTDataByDay(1, this.hq.prevclose);
                this.latest5[_loc_3][0].totalVolume = 0;
                this.latest5[_loc_3][0].date = this._isFake ? (this.hq.date) : (this._dataTool.cloneDate(this.dates[this.dates.length - 5 + _loc_3]));
                this.latest5[_loc_3][0].prevclose = this.hq.prevclose;
                _loc_3 = _loc_3 + 1;
            }
            this.latest5.push(this.datas_1);
            this.datas_5 = this.latest5;
            this.datas_3 = [];
            var _loc_4:* = this.dates.length;
            if (this._isFake)
            {
                _loc_3 = 0;
                while (_loc_3 < _loc_4)
                {
                    
                    this.datas_3.push({price:this.hq.prevclose, date:this.hq.date});
                    _loc_3 = _loc_3 + 1;
                }
            }
            else
            {
                _loc_3 = 0;
                while (_loc_3 < _loc_4)
                {
                    
                    this.datas_3.push({price:this.hq.prevclose, date:this.dates[_loc_3]});
                    _loc_3 = _loc_3 + 1;
                }
            }
            this.datas_3[(this.datas_3.length - 1)].price = this.hq.price;
            this.datas_3[0].prevclose = this.hq.prevclose;
            if (this.initCallBackFun != null)
            {
                this.initCallBackFun();
            }
            this.inited = true;
            return;
        }// end function

        public function isLates5() : Boolean
        {
            return this.datas_5 == this.latest5;
        }// end function

        protected function handle243orMore(param1:Array) : void
        {
            var _loc_2:Object = null;
            if (param1.length > 242)
            {
                _loc_2 = param1.shift();
                while (param1.length > 242)
                {
                    
                    param1.shift();
                }
                param1[0].prevclose = _loc_2.prevclose;
                param1[0].date = _loc_2.date;
            }
            return;
        }// end function

        private function on5AndYTErr(event:Event) : void
        {
            var _loc_2:String = null;
            event.target.removeEventListener(IOErrorEvent.IO_ERROR, this.on5AndYTErr);
            event.target.removeEventListener(Event.COMPLETE, this.onAllTDataLoaded);
            event.target.removeEventListener(SecurityErrorEvent.SECURITY_ERROR, this.on5AndYTErr);
            if (this._isFake)
            {
                this.createBlackTData();
                return;
            }
            if (this.hq.name.charAt(0) == "N")
            {
                this.createBlackTData();
            }
            else
            {
                var _loc_3:String = this;
                _loc_3._retry5ytCount = this._retry5ytCount + 1;
                if (this._retry5ytCount++ < this._RETRY_COUNT)
                {
                    this.load5AndYT(true);
                    _loc_2 = "erryear5t";
                }
                else
                {
                    this.createBlackTData();
                    _loc_2 = "stopyt";
                }
                this._cfg.sendStatistic("flasherr.html?type=" + _loc_2);
            }
            return;
        }// end function

        protected function onOneOk(event:Event = null) : void
        {
            var _loc_2:Array = null;
            if (!event)
            {
                if (this._isFake)
                {
                    this.datas_1 = this._dataTool.getSpaceTDataByDay(1, this.hq.price, false);
                }
                else
                {
                    this.datas_1 = this._dataTool.getSpaceTDataByDay(1, this.hq.price, true);
                }
            }
            else
            {
                event.target.removeEventListener(Event.COMPLETE, this.onOneOk);
                event.target.removeEventListener(IOErrorEvent.IO_ERROR, this.oneTIoErr);
                _loc_2 = event.target.data.split("\"");
                if (_loc_2.length < 2 || _loc_2[1] == "")
                {
                    this.datas_1 = this._dataTool.getSpaceTDataByDay(1, this.hq.price, true);
                }
                else
                {
                    this.datas_1 = this._dataTool.b64arrayFormat(this._dataTool.b642int32(_loc_2[1]), false);
                }
            }
            this.handle243orMore(this.datas_1);
            if (this.datas_1[0].price <= 0)
            {
                var _loc_3:* = this.hq.prevclose;
                this.datas_1[0].avg_price = this.hq.prevclose;
                this.datas_1[0].price = _loc_3;
            }
            if (this.datas_1[0].volume > 0)
            {
                this.datas_1[0].price = this.hq.open;
            }
            this.datas_1[0].date = this._dataTool.cloneDate(this.hq.date);
            this.datas_1[0].prevclose = this.hq.prevclose;
            this.tdataObj = new TDataObj(this.hq);
            this.calcDataObj(1, this.hq.date);
            this.load5AndYT();
            return;
        }// end function

        private function onAllTDataLoaded(event:Event) : void
        {
            var _loc_9:Number = NaN;
            var _loc_10:uint = 0;
            event.target.removeEventListener(IOErrorEvent.IO_ERROR, this.on5AndYTErr);
            event.target.removeEventListener(SecurityErrorEvent.SECURITY_ERROR, this.on5AndYTErr);
            event.target.removeEventListener(Event.COMPLETE, this.onAllTDataLoaded);
            var _loc_2:* = String(event.target.data);
            if (!_loc_2)
            {
                this.createBlackTData();
                return;
            }
            var _loc_3:* = _loc_2.split("\"");
            if (_loc_3.length < 4)
            {
                this.createBlackTData();
                return;
            }
            var _loc_4:* = String(_loc_3[1]).split(",");
            var _loc_5:Array = [];
            var _loc_6:* = this._cfg.isBond ? (10) : (100);
            var _loc_7:uint = 0;
            while (_loc_7 < _loc_4.length)
            {
                
                if (_loc_7 == 0 && _loc_4[0] == "")
                {
                    _loc_5.push(this._dataTool.getSpaceTDataByDay(1, this.hq.prevclose));
                }
                else
                {
                    _loc_5.push(this._dataTool.S_KLC_D(_loc_4[_loc_7]));
                    this.handle243orMore(_loc_5[_loc_7]);
                }
                _loc_9 = 0;
                _loc_10 = 0;
                while (_loc_10 < 242)
                {
                    
                    _loc_5[_loc_7][_loc_10].volume = _loc_5[_loc_7][_loc_10].volume / _loc_6;
                    _loc_9 = _loc_9 + Number(_loc_5[_loc_7][_loc_10].volume);
                    _loc_10 = _loc_10 + 1;
                }
                _loc_5[_loc_7][0].totalVolume = _loc_9;
                _loc_7 = _loc_7 + 1;
            }
            this.dealTimeSharingData(_loc_5);
            var _loc_8:* = this._dataTool.S_KLC_D(_loc_3[3]);
            this.dealCloseLineData(_loc_8);
            if (this.initCallBackFun != null)
            {
                this.initCallBackFun();
            }
            this.inited = true;
            return;
        }// end function

        public function update() : void
        {
            if (this.datas_1)
            {
                this.datas_1[this.hq.index].price = this.hq.price;
            }
            if (this.datas_1 && this.datas_1[0].volume > 0)
            {
                this.datas_1[0].price = this.hq.open;
            }
            if (this.datas_3)
            {
                this.datas_3[(this.datas_3.length - 1)].price = this.hq.price;
            }
            return;
        }// end function

        protected function oneTIoErr(event:IOErrorEvent) : void
        {
            var _loc_3:String = null;
            var _loc_2:* = URLLoaderWithReq(event.target);
            _loc_2.removeEventListener(Event.COMPLETE, this.onOneOk);
            _loc_2.removeEventListener(IOErrorEvent.IO_ERROR, this.oneTIoErr);
            var _loc_4:String = this;
            _loc_4._retry1tCount = this._retry1tCount + 1;
            if (++this._retry1tCount > this._RETRY_COUNT)
            {
                _loc_3 = "stop1t";
            }
            else
            {
                this._dataTool.loadDataFromUrl(_loc_2.urlRequest.url, this.onOneOk, null, this.oneTIoErr);
                _loc_3 = "err1t";
            }
            this._cfg.sendStatistic("flasherr.html?type=" + _loc_3);
            return;
        }// end function

        public function calcDataObj(param1:uint, param2:Date) : void
        {
            var _loc_3:Array = null;
            var _loc_4:uint = 0;
            var _loc_5:uint = 0;
            var _loc_6:uint = 0;
            var _loc_7:uint = 0;
            if (!param2)
            {
                return;
            }
            if (param1 == 1 && this._dataTool.isSameDay_date(param2, this.hq.date))
            {
                _loc_3 = this.datas_1;
            }
            else if (param1 <= 5)
            {
                _loc_4 = 0;
                while (_loc_4 < 5)
                {
                    
                    if (this._dataTool.isSameDay_date(this.datas_5[_loc_4][0].date, param2))
                    {
                        break;
                    }
                    _loc_4 = _loc_4 + 1;
                }
                _loc_3 = [];
                _loc_5 = _loc_4 + param1;
                while (_loc_4 < _loc_5)
                {
                    
                    _loc_3 = _loc_3.concat(this.datas_5[_loc_4]);
                    _loc_4 = _loc_4 + 1;
                }
            }
            else if (param1 == 365 || param1 == 665 || param1 == 965)
            {
                _loc_6 = this.datas_3.length;
                _loc_4 = 0;
                while (_loc_4 < _loc_6)
                {
                    
                    if (this._dataTool.isSameDay_date(this.datas_3[_loc_4].date, param2))
                    {
                        break;
                    }
                    _loc_4 = _loc_4 + 1;
                }
                if (_loc_4 >= _loc_6)
                {
                    return;
                }
                if (_loc_4 != 0)
                {
                    this.datas_3[_loc_4].prevclose = this.datas_3[(_loc_4 - 1)].price;
                }
                if (param1 == 365)
                {
                    _loc_6 = Math.ceil(this.datas_3.length / 3);
                }
                else if (param1 == 665)
                {
                    _loc_6 = Math.ceil(this.datas_3.length / 3 * 2);
                }
                _loc_7 = _loc_6 + _loc_4;
                if (_loc_7 + 5 > this.datas_3.length)
                {
                    _loc_7 = this.datas_3.length;
                }
                _loc_3 = this.datas_3.slice(_loc_4, _loc_7);
            }
            return;
        }// end function

        private function dealCloseLineData(param1:Array) : void
        {
            var _loc_6:uint = 0;
            if (param1.length == 0)
            {
                param1.push({prevclose:this.hq.prevclose, close:this.hq.price, date:this._dataTool.cloneDate(this.hq.date)});
            }
            if (!this._dataTool.isSameDay_date(param1[(param1.length - 1)].date, this.hq.date))
            {
                param1.push({close:this.hq.price, date:this._dataTool.cloneDate(this.hq.date)});
            }
            if (!param1[0].prevclose || param1[0].prevclose <= 0)
            {
                Object(param1[0]).prevclose = param1[0].price || this.hq.prevclose;
            }
            var _loc_2:* = param1.length;
            this.datas_3 = [];
            var _loc_3:* = this.dates.length;
            var _loc_4:uint = 0;
            var _loc_5:uint = 0;
            while (_loc_5 < _loc_3)
            {
                
                _loc_6 = _loc_4;
                while (_loc_6 < _loc_2)
                {
                    
                    if (this._dataTool.isSameDay_date(param1[_loc_6].date, this.dates[_loc_5]))
                    {
                        this.datas_3.push({price:param1[_loc_6].close, date:this.dates[_loc_5]});
                        _loc_4 = _loc_6 + 1;
                        break;
                    }
                    if (_loc_6 == (_loc_2 - 1))
                    {
                        if (_loc_4 == 0)
                        {
                            this.datas_3.push({price:param1[0].prevclose, prevclose:param1[0].prevclose, date:this.dates[_loc_5]});
                        }
                        else
                        {
                            this.datas_3.push({price:param1[(_loc_4 - 1)].close, date:this.dates[_loc_5]});
                        }
                    }
                    _loc_6 = _loc_6 + 1;
                }
                _loc_5 = _loc_5 + 1;
            }
            return;
        }// end function

        public function initData(param1:String, param2:String, param3:Number, param4:Boolean = false) : void
        {
            var _loc_5:String = null;
            this._isFake = param4;
            this._lastfive = param3;
            if (!this.hq)
            {
                this.hq = new HQ(param1, param2);
            }
            else
            {
                this.hq.update(param2);
            }
            if (this._isFake)
            {
                this.onOneOk(null);
                return;
            }
            if (this.hq.isStime)
            {
                this.onOneOk(null);
            }
            else
            {
                _loc_5 = param1;
                this._dataTool.loadDataFromUrl(this._cfg.HQ_URL_PREFIX + "&list=ml_" + _loc_5, this.onOneOk, null, this.oneTIoErr);
            }
            return;
        }// end function

        protected function load5AndYT(param1:Boolean = false) : void
        {
            this._dataTool.loadDataFromUrl(this._cfg.FINANCE_URL + this.hq.symbol + this.TDATA_URL_END + this.hq.today + (param1 ? ("&r=" + Math.random()) : ("")), this.onAllTDataLoaded, null, this.on5AndYTErr, this.on5AndYTErr);
            return;
        }// end function

    }
}
